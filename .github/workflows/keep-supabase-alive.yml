name: Keep Supabase Projects Alive with Alerts

on:
  schedule:
    - cron: "0 */12 * * *" # every 12 hours
  workflow_dispatch:

jobs:
  keep_alive:
    runs-on: ubuntu-latest

    steps:
      - name: Ping all Supabase projects
        id: ping
        run: |
          urls=(
            "https://ritcecccqmbekeamlysr.supabase.co/rest/v1/"
            "https://cqjcpsgerdbzjcasozhj.supabase.co/rest/v1/"
            "https://tsnkaxxoyycsahbhqtez.supabase.co/rest/v1/"
            "https://voivdsecewtkmanteiri.supabase.co/rest/v1/"
            "https://ngfaueanjefzvfguggmu.supabase.co/rest/v1/"
          )

          FAILED=""

          for url in "${urls[@]}"; do
            echo "üîÑ Pinging $url"
            if curl -I --max-time 15 "$url" > /dev/null 2>&1; then
              echo "‚úÖ $url OK"
            else
              echo "‚ùå $url failed"
              FAILED="${FAILED}- $url\n"
            fi
          done

          if [ -n "$FAILED" ]; then
            echo "failed_urls<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FAILED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Send Email if any project failed
        if: steps.ping.outputs.failed_urls
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ö†Ô∏è Supabase Project Ping Failed"
          to: allbusiness1z1234@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Some Supabase projects failed the keep-alive ping:

            ${{ steps.ping.outputs.failed_urls }}
